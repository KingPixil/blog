<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="Kabir Shah">

		<title>Inventing Monads | Blog of Kabir Shah</title>

		<link rel="shortcut icon" href="/img/logo-fill.png"/>
		<link rel="alternate" type="application/json" title="Kabir Shah" href="/feed.json"/>

		<link href="https://fonts.googleapis.com/css?family=Crimson+Pro:400,700|Inconsolata&display=swap" rel="stylesheet"/>
		
		<link rel="stylesheet" type="text/css" href="/css/lib/grain.min.css"/>
		<link rel="stylesheet" type="text/css" href="/css/styles.css"/>

		<script>
			(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
				(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
					m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");

			ga("create", "UA-70792533-7", "auto");
			ga("send", "pageview");
		</script>
	</head>

	<body class="a-x-c">
		<a href="/" id="back"><svg width="37" height="24" viewBox="0 0 37 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Arrow</title><path id="back-arrow" d="M36.0607 1.06066c.5857-.585786.5857-1.535534 0-2.12132l-9.546-9.54594c-.5858-.5858-1.5355-.5858-2.1213 0-.5858.5858-.5858 1.53553 0 2.12132L32.8787 0l-8.4853 8.48528c-.5858.58579-.5858 1.53552 0 2.12132.5858.5858 1.5355.5858 2.1213 0l9.546-9.54594zM0 1.5h35v-3H0v3z" transform="rotate(180 18.5 6)" fill="#888" /></svg></a>
		<div class="s-x-26 m-y-5">
			<div>
				<h1 class="s-x-26 a-t-c">Inventing Monads</h1>
				<p class="s-x-26 a-t-c">August 1, 2019</p>
			</div>
			<div class="s-x-26 m-y-3">
				<p class="s-x-26">Monads are an esoteric concept to many, resulting in hundreds of tutorials, guides, and examples attempting to explain them. Curious developers might look into them only to find the classic answer, &quot;Monads are monoids in the category of endofunctors&quot;. In the end, they&#39;re just another abstraction to help deal with repetitive patterns in functional code.</p><p class="s-x-26">This guide will use JavaScript instead of a pure functional programming language (e.g. Haskell) to make things more approachable for developers accustomed to imperative languages. It will, however, assume you have basic knowledge of functional programming, including currying and lambdas.</p><p class="s-x-26">Think of monads as a way to overload a semicolon. It might sound a little crazy at first, but imagine being able to override the semicolon to reduce boilerplate in specific code blocks. That&#39;s basically how monads are used in practice.</p><p class="s-x-26">As a final note before we start, I am by no means an expert on this topic. I&#39;m fifteen years old with good knowledge of mostly high school level math, and may have missed some parts. Monads are complex and closely tied with category theory, which is a very abstract and vast branch of mathematics that can be hard to grok. If I missed something, feel free to reach out and let me know â€” I&#39;m always open to learning something new.</p><h2 id="blocks" class="s-x-26">Blocks</h2><p class="s-x-26">First, many languages have a pattern that allows for creating a set of bindings and then a value based on it. In JavaScript, this is accomplished with a self-invoking function. They can also be transformed into a recursive structure of function calls with variable values. Being explicit about composing functions in this way can help clarify how exactly monads can modify the flow of a program.</p><p class="s-x-26">For example, the following block of code:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> middleName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">getId</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">getUser</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getMiddleName</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">Can be represented as:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> middleName <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span>
        <span class="token function">getMiddleName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">It&#39;s a dense representation, but they are equivalent. Note that functions are called with a space between the name and opening parenthesis, this isn&#39;t common syntax but it&#39;s valid JavaScript. It&#39;s there to simulate &quot;call by juxtaposition&quot; syntax in languages like Haskell, where functions are called with <code class="s-b-2 p-x-2 p-y-2">f x y z</code>. But instead of calling them like you normally would in JavaScript with <code class="s-b-2 p-x-2 p-y-2">f(x)(y)(z)</code>, we call them with <code class="s-b-2 p-x-2 p-y-2">f (x) (y) (z)</code>.</p><p class="s-x-26">This functional version of blocks works by breaking them down into two parts:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> middleName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">getId</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">getUser</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getMiddleName</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">Instead of having everything in the same block, we define a &quot;block&quot; simply as a value based on a variable. In the outer block, the <code class="s-b-2 p-x-2 p-y-2">id</code> is the variable, and the value is a function of the <code class="s-b-2 p-x-2 p-y-2">id</code>. In this case, the value is another block, where <code class="s-b-2 p-x-2 p-y-2">user</code> is the variable and the value is a function of the user.</p><h2 id="null-everywhere" class="s-x-26">Null Everywhere</h2><p class="s-x-26">Revisiting the previous example, the code might look like this:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> middleName <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span>
        <span class="token function">getMiddleName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">It&#39;s clean enough, right? Now imagine if <code class="s-b-2 p-x-2 p-y-2">id</code> could be <code class="s-b-2 p-x-2 p-y-2">null</code>, <code class="s-b-2 p-x-2 p-y-2">user</code> could be <code class="s-b-2 p-x-2 p-y-2">null</code>, or <code class="s-b-2 p-x-2 p-y-2">middleName</code> could be <code class="s-b-2 p-x-2 p-y-2">null</code>. The utility functions will all end up looking like this:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token comment">// Simulate the fetching of an ID.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getId</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> random <span class="token operator">&lt;</span> <span class="token number">700</span> <span class="token operator">?</span> random <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Simulate the fetching of a user.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getUser</span> <span class="token operator">=</span> <span class="token parameter">id</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            first<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
            last<span class="token punctuation">:</span> <span class="token string">"Doe"</span><span class="token punctuation">,</span>
            middle<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.7</span> <span class="token operator">?</span> <span class="token string">"Bob"</span> <span class="token punctuation">:</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Simulate the fetching of a middle name.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getMiddleName</span> <span class="token operator">=</span> <span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>middle <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> user<span class="token punctuation">.</span>middle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">Every utility function has to check and handle <code class="s-b-2 p-x-2 p-y-2">null</code> values, and has the possibility of returning <code class="s-b-2 p-x-2 p-y-2">null</code> as well. But what if we checked for it automatically?</p><p class="s-x-26">Once again, the functional version of the block would look like this:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> middleName <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span>
        <span class="token function">getMiddleName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">Looking at this, we can find a pattern: every <code class="s-b-2 p-x-2 p-y-2">apply</code> takes a nullable value as input and applies it to a function. This function always returns another nullable value, and by extension <code class="s-b-2 p-x-2 p-y-2">apply</code> needs to also return a nullable value because it may be used within the function itself. Instead of handling <code class="s-b-2 p-x-2 p-y-2">null</code> within each function, <code class="s-b-2 p-x-2 p-y-2">apply</code> can handle it.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> x <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">Since the inputs can be <code class="s-b-2 p-x-2 p-y-2">null</code>, it checks and returns <code class="s-b-2 p-x-2 p-y-2">null</code> whenever the input is <code class="s-b-2 p-x-2 p-y-2">null</code>. If not, it passes <code class="s-b-2 p-x-2 p-y-2">x</code> to the function. It treats the function as a black box that can return anything, but assumes that it takes a non-null value as input. Since <code class="s-b-2 p-x-2 p-y-2">apply</code> itself will have a nullable value as input, it handles the <code class="s-b-2 p-x-2 p-y-2">null</code> case and then passes any real values into the function. Now, the full the code will look like this:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token comment">// Simulate the fetching of an ID.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getId</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> random <span class="token operator">&lt;</span> <span class="token number">700</span> <span class="token operator">?</span> random <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Simulate the fetching of a user.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getUser</span> <span class="token operator">=</span> <span class="token parameter">id</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    first<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
    last<span class="token punctuation">:</span> <span class="token string">"Doe"</span><span class="token punctuation">,</span>
    middle<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.7</span> <span class="token operator">?</span> <span class="token string">"Bob"</span> <span class="token punctuation">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Simulate the fetching of a middle name.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getMiddleName</span> <span class="token operator">=</span> <span class="token parameter">user</span> <span class="token operator">=></span> user<span class="token punctuation">.</span>middle<span class="token punctuation">;</span>

<span class="token comment">// Get the middle name, if it exists.</span>
<span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> x <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> middleName <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span>
        <span class="token function">getMiddleName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>middleName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 49% => "Bob", 51% => null</span></code></pre><h2 id="logging" class="s-x-26">Logging</h2><p class="s-x-26">Keeping the same example, let&#39;s say we want to keep track of log messages. In a functional language, you can&#39;t modify a global variable to keep track of all of the messages. Instead, each function can return an output along with a log message.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">getId</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"Got an id of 7."</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getUser</span> <span class="token operator">=</span> <span class="token parameter">id</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    first<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
    last<span class="token punctuation">:</span> <span class="token string">"Doe"</span><span class="token punctuation">,</span>
    middle<span class="token punctuation">:</span> <span class="token string">"Bob"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> id<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">" Got a user with name John Bob Doe."</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getMiddleName</span> <span class="token operator">=</span> <span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">[</span>user<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>middle<span class="token punctuation">,</span> user<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">" Got the middle name of a user."</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> middleName <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span>
        <span class="token function">getMiddleName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">This is messy, and we had to modify the utility functions in order to handle the incoming array input. Instead, we can change the <code class="s-b-2 p-x-2 p-y-2">apply</code> function to propagate the log for us. In this case, the inputs to <code class="s-b-2 p-x-2 p-y-2">apply</code> always have the structure of <code class="s-b-2 p-x-2 p-y-2">[output, log]</code>. However, we want the function <code class="s-b-2 p-x-2 p-y-2">f</code> to only receive the output. Unlike the previous example, we will now assume that <code class="s-b-2 p-x-2 p-y-2">f</code> returns the same <code class="s-b-2 p-x-2 p-y-2">[output, log]</code> pair. Since <code class="s-b-2 p-x-2 p-y-2">f</code> can return the output of <em>another</em> <code class="s-b-2 p-x-2 p-y-2">apply</code>, we need to return the same type from <code class="s-b-2 p-x-2 p-y-2">apply</code>.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">Since everything has the same array type, we take it as an input. Instead of passing the log to the function though, we only pass the output of the value <code class="s-b-2 p-x-2 p-y-2">x[0]</code> to the function <code class="s-b-2 p-x-2 p-y-2">f</code>. We assume that this function will return its own output and log. Since this function can return the output of <code class="s-b-2 p-x-2 p-y-2">apply</code>, we return a new pair with the function output along with the combined logs.</p><p class="s-x-26">The full code will then be much simpler, and doesn&#39;t include anything related to the previous log message in the utility functions:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token comment">// Get various data from a user.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getId</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">"Got an id of 7."</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getUser</span> <span class="token operator">=</span> <span class="token parameter">id</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    first<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
    last<span class="token punctuation">:</span> <span class="token string">"Doe"</span><span class="token punctuation">,</span>
    middle<span class="token punctuation">:</span> <span class="token string">"Bob"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"Got a user with name John Bob Doe."</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getMiddleName</span> <span class="token operator">=</span> <span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span>middle<span class="token punctuation">,</span> <span class="token string">"Got the middle name of a user."</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Get the middle name along with logs.</span>
<span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> middleName <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">id</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span>
        <span class="token function">getMiddleName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>middleName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// => ["Bob", "Got an id of 7. Got a user with name John Bob Doe. Got the middle name of a user."]</span></code></pre><h2 id="global-environment" class="s-x-26">Global Environment</h2><p class="s-x-26">Let&#39;s say we have a global object fetched from somewhere, and it holds data for a user.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
    first<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
    last<span class="token punctuation">:</span> <span class="token string">"Doe"</span>
<span class="token punctuation">}</span></code></pre><p class="s-x-26">Along with that, we have a calculation based on this environment.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">getInitials</span> <span class="token operator">=</span> <span class="token parameter">environment</span> <span class="token operator">=></span> environment<span class="token punctuation">.</span>first<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> environment<span class="token punctuation">.</span>last<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token parameter">initials</span> <span class="token operator">=></span> <span class="token parameter">environment</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>initials<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>first<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>last<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getIdentity</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token parameter">environment</span> <span class="token operator">=></span> environment<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> identity <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getInitials</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">initials</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getName</span> <span class="token punctuation">(</span>initials<span class="token punctuation">)</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span>
        <span class="token function">getIdentity</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">In this case, every single function requires the <code class="s-b-2 p-x-2 p-y-2">environment</code> as an input. What if we made that implicit?</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">getInitials</span> <span class="token operator">=</span> <span class="token parameter">environment</span> <span class="token operator">=></span> environment<span class="token punctuation">.</span>first<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> environment<span class="token punctuation">.</span>last<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token parameter">initials</span> <span class="token operator">=></span> <span class="token parameter">environment</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">initials</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>first<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>last<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getIdentity</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token parameter">environment</span> <span class="token operator">=></span> environment<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token function">name</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> identity <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span>getInitials<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">initials</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getName</span> <span class="token punctuation">(</span>initials<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span>
        <span class="token function">getIdentity</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">It looks nicer, but the utility functions had to change. They now have to call their first argument with the environment in order to get their true value. However, <code class="s-b-2 p-x-2 p-y-2">apply</code> can make some assumptions in this case. It can assume that every input is a <em>function of the environment</em>, and every function takes a value and returns another function of the environment.</p><p class="s-x-26">We can solve this problem using <code class="s-b-2 p-x-2 p-y-2">apply</code>. Every input <code class="s-b-2 p-x-2 p-y-2">x</code> is a function of the environment, but it would be nice if given function <code class="s-b-2 p-x-2 p-y-2">f</code> could expect the <em>output</em> of <code class="s-b-2 p-x-2 p-y-2">x</code>. How can we get the output out of <code class="s-b-2 p-x-2 p-y-2">x</code>? We need to pass it the environment, so we can return a <em>new function</em> that depends on the environment and calls <code class="s-b-2 p-x-2 p-y-2">x</code>. Now it can pass the output to <code class="s-b-2 p-x-2 p-y-2">f</code> as it expects. Since <code class="s-b-2 p-x-2 p-y-2">f</code> is also a function of the environment, we can call it with our given environment and finally return the result.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token parameter">environment</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token function">x</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">It&#39;s a little confusing, but <code class="s-b-2 p-x-2 p-y-2">apply</code> uses the assumptions to its advantage. First of all, it returns a function of the environment. This function applies the environment to the input <code class="s-b-2 p-x-2 p-y-2">x</code>, and passes it to <code class="s-b-2 p-x-2 p-y-2">f</code>. Since we assume <code class="s-b-2 p-x-2 p-y-2">f</code> returns another function of the environment, we apply it with the given environment <em>again</em> and return its output.</p><p class="s-x-26">With that, the final code looks like:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token comment">// Utility functions to return calculations based on an environment.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getInitials</span> <span class="token operator">=</span> <span class="token parameter">environment</span> <span class="token operator">=></span> environment<span class="token punctuation">.</span>first<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> environment<span class="token punctuation">.</span>last<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token parameter">initials</span> <span class="token operator">=></span> <span class="token parameter">environment</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>initials<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>first<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>last<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getIdentity</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=></span> <span class="token parameter">environment</span> <span class="token operator">=></span> environment<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>

<span class="token comment">// Get the identity of the environment user.</span>
<span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token parameter">environment</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token function">x</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> identity <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span>getInitials<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">initials</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span><span class="token function">getName</span> <span class="token punctuation">(</span>initials<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span>
        <span class="token function">getIdentity</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Since `identity` is a function of an environment, we can pass it any environment.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">identity</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
    first<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>
    last<span class="token punctuation">:</span> <span class="token string">"Doe"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// => 7 JD John Doe</span></code></pre><h2 id="passing-state" class="s-x-26">Passing State</h2><p class="s-x-26">Let&#39;s say we have a state for holding the seed of a random number generator.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token number">7</span></code></pre><p class="s-x-26">In pure functional languages, there is no concept of mutation, only pure functions. However, for things like random number generation, there is often a seed that is kept track of as state. It needs to be sent around so that the next number and seed can be generated from it. We can write a block like this:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">getRandom</span> <span class="token operator">=</span> <span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">*</span> state <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>result <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">,</span> result<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getSum</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">y</span> <span class="token operator">=></span> <span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> xResult <span class="token operator">=</span> <span class="token function">x</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> yResult <span class="token operator">=</span> <span class="token function">y</span> <span class="token punctuation">(</span>xResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>xResult<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> yResult<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> yResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token function">f</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sum <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span>getRandom<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">random1</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span>getRandom<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">random2</span> <span class="token operator">=></span>
        <span class="token function">getSum</span> <span class="token punctuation">(</span>random1<span class="token punctuation">)</span> <span class="token punctuation">(</span>random2<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">In this example, every value is a function of state that returns and output along with new state. It&#39;s not the best code though, because <code class="s-b-2 p-x-2 p-y-2">getSum</code> has to call both of its arguments with the state in order to get their value, then it has to correctly manage the latest state and return it.</p><p class="s-x-26">However, <code class="s-b-2 p-x-2 p-y-2">apply</code> can assume that every input is a <em>function of state that returns output and new state</em>. It can also assume that the function takes only an output value and returns another function of state.</p><p class="s-x-26">Using these assumptions, it would be nice if the function <code class="s-b-2 p-x-2 p-y-2">f</code> could expect only the output portion of <code class="s-b-2 p-x-2 p-y-2">x</code>&#39;s return value. To get <code class="s-b-2 p-x-2 p-y-2">x</code>&#39;s output, we need to call it with the state, so we can return a new function of state. Within this function, we can pass <code class="s-b-2 p-x-2 p-y-2">x</code> the state and get an output along with new state. Now we can supply <code class="s-b-2 p-x-2 p-y-2">f</code> the output, and since <code class="s-b-2 p-x-2 p-y-2">f</code> returns a function of state, we can call it again with the new state returned by <code class="s-b-2 p-x-2 p-y-2">x</code>. Finally, we can return this result.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">x</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">f</span> <span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">It&#39;s elegant, but dense. Since the output of the given function is assumed to be another function of state, <code class="s-b-2 p-x-2 p-y-2">apply</code> starts by returning a new function of state. This function calls the input <code class="s-b-2 p-x-2 p-y-2">x</code> with the state to get an output along with new state. It passes the output to <code class="s-b-2 p-x-2 p-y-2">f</code>, which expects just the output of <code class="s-b-2 p-x-2 p-y-2">x</code> as its input. Since <code class="s-b-2 p-x-2 p-y-2">f</code> returns another function of state, it calls it again with the new state returned by <code class="s-b-2 p-x-2 p-y-2">x</code>.</p><p class="s-x-26">The full code looks like:</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token comment">// Utility functions for number manipulation.</span>
<span class="token keyword">const</span> <span class="token function-variable function">getRandom</span> <span class="token operator">=</span> <span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token number">7</span> <span class="token operator">*</span> state <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Random number: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>result <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Log random numbers for debugging.</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>result <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">,</span> result<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getSum</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">y</span> <span class="token operator">=></span> <span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">[</span>x <span class="token operator">+</span> y<span class="token punctuation">,</span> state<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Generate the sum of two random numbers.</span>
<span class="token keyword">const</span> <span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token parameter">x</span> <span class="token operator">=></span> <span class="token parameter">f</span> <span class="token operator">=></span> <span class="token parameter">state</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">x</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">f</span> <span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sum <span class="token operator">=</span> <span class="token function">apply</span> <span class="token punctuation">(</span>getRandom<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">random1</span> <span class="token operator">=></span>
    <span class="token function">apply</span> <span class="token punctuation">(</span>getRandom<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token parameter">random2</span> <span class="token operator">=></span>
        <span class="token function">getSum</span> <span class="token punctuation">(</span>random1<span class="token punctuation">)</span> <span class="token punctuation">(</span>random2<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// => Random number: 56</span>
<span class="token comment">// => Random number: 99</span>
<span class="token comment">// => [155, 399]</span></code></pre><h2 id="conclusion" class="s-x-26">Conclusion</h2><p class="s-x-26">You&#39;ll notice how I didn&#39;t mention monads throughout the examples. That&#39;s because the code was just written using a natural abstraction, and that abstraction was the <code class="s-b-2 p-x-2 p-y-2">apply</code> function, which applied functions that made up do-blocks in special ways. The truth is, we just implemented four different monads:</p><ol>
<li><p class="s-x-26">Null Everywhere - <code class="s-b-2 p-x-2 p-y-2">Maybe</code> Monad - Assumed <code class="s-b-2 p-x-2 p-y-2">x: nullable</code> and <code class="s-b-2 p-x-2 p-y-2">f: nullable -&gt; any</code></p></li><li><p class="s-x-26">Logging - <code class="s-b-2 p-x-2 p-y-2">Writer</code> Monad - Assumed <code class="s-b-2 p-x-2 p-y-2">x: [any, string]</code> and <code class="s-b-2 p-x-2 p-y-2">f: any -&gt; [any, string]</code></p></li><li><p class="s-x-26">Global Environment - <code class="s-b-2 p-x-2 p-y-2">Reader</code> Monad - Assumed <code class="s-b-2 p-x-2 p-y-2">x: environment -&gt; any</code> and <code class="s-b-2 p-x-2 p-y-2">f: any -&gt; environment -&gt; any</code></p></li><li><p class="s-x-26">Passing State - <code class="s-b-2 p-x-2 p-y-2">State</code> Monad - Assumed <code class="s-b-2 p-x-2 p-y-2">x: state -&gt; [any, state]</code> and <code class="s-b-2 p-x-2 p-y-2">f: any -&gt; state -&gt; [any, state]</code></p></li></ol>
<p class="s-x-26">The monad itself is a triple of a type constructor, a type converter, and a type combinator.</p><p class="s-x-26">The type constructor is just a way of defining the type of value that stayed constant throughout the do-blocks. For example, the <code class="s-b-2 p-x-2 p-y-2">Maybe</code> monad type constructor returns <code class="s-b-2 p-x-2 p-y-2">T | null</code>, and the <code class="s-b-2 p-x-2 p-y-2">State</code> monad type constructor returns <code class="s-b-2 p-x-2 p-y-2">state -&gt; [output, state]</code>.</p><p class="s-x-26">The type converter is a way of creating a &quot;unit&quot; value of the type. For example, the <code class="s-b-2 p-x-2 p-y-2">Writer</code> monad type converter is <code class="s-b-2 p-x-2 p-y-2">const unit = x =&gt; [x, &quot;&quot;]</code>. It wraps any value within a <code class="s-b-2 p-x-2 p-y-2">Writer</code> type that includes the value along with an empty log. We didn&#39;t cover these much to reduce the complexity of getting started.</p><p class="s-x-26">The type combinator is another name for our <code class="s-b-2 p-x-2 p-y-2">apply</code> function, with a signature of <code class="s-b-2 p-x-2 p-y-2">m -&gt; (any -&gt; m) -&gt; m</code>. It basically means that it accepts an input with the type constructor of a monad and a function that returns the same type. Using these two, it returns an output with the same type. This is commonly named <code class="s-b-2 p-x-2 p-y-2">bind</code>.</p><p class="s-x-26">Together, the three of these form a monad. Think of it like this: a do-block can be split into recursive <code class="s-b-2 p-x-2 p-y-2">apply</code> calls. If we make assumptions that every input is a certain type, then <code class="s-b-2 p-x-2 p-y-2">apply</code> can transform the input before applying it to the function. If we make assumptions that the function outputs a certain type, then <code class="s-b-2 p-x-2 p-y-2">apply</code> can transform the output of the function to combine it with the original input. Basically, it can return whatever it wants using the given input and function. To make this even more useful, <code class="s-b-2 p-x-2 p-y-2">apply</code> can return the same type that it assumes the function will return. This allows the function to use <code class="s-b-2 p-x-2 p-y-2">apply</code> within itself.</p><p class="s-x-26">Some other great resources on monads include:</p><ul>
<li><p class="s-x-26"><a href="http://blog.sigfpe.com/2006/08/you-could-have-invented-monads-and.html">You Could Have Invented Monads! (And Maybe You Already Have.)</a></p></li><li><p class="s-x-26"><a href="http://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html">Functors, Applicatives, And Monads In Pictures</a></p></li><li><p class="s-x-26"><a href="http://adit.io/posts/2013-06-10-three-useful-monads.html">Three Useful Monads</a></p></li><li><p class="s-x-26"><a href="https://en.wikipedia.org/wiki/Monad_(functional_programming)">Monad (functional programming)</a></p></li></ul>
<p class="s-x-26">In the end, the monad is just an abstraction that has access to the inner workings of block expressions, giving it control over how things flow from input to function.</p>
			</div>
			<div class="s-x-26 a-x-sb">
				<p><a href="https://kabir.sh">Portfolio</a></p>
				<p><a href="https://blog.kabir.sh">Blog</a></p>
				<p><a href="https://twitter.com/kbrshah">Twitter</a></p>
				<p><a href="https://github.com/kbrsh">GitHub</a></p>
			</div>
		</div>
	</body>
</html>
