<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="Kabir Shah">

		<title>Moon: Pure UI | Blog of Kabir Shah</title>

		<link rel="shortcut icon" href="/img/logo-fill.png"/>
		<link rel="alternate" type="application/json" title="Kabir Shah" href="/feed.json"/>

		<link href="https://fonts.googleapis.com/css?family=Crimson+Pro:400,700|Inconsolata&display=swap" rel="stylesheet"/>
		
		<link rel="stylesheet" type="text/css" href="/css/lib/grain.min.css"/>
		<link rel="stylesheet" type="text/css" href="/css/styles.css"/>

		<script>
			(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
				(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
					m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");

			ga("create", "UA-70792533-7", "auto");
			ga("send", "pageview");
		</script>
	</head>

	<body class="a-x-c">
		<a href="/" id="back"><svg width="37" height="24" viewBox="0 0 37 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Arrow</title><path id="back-arrow" d="M36.0607 1.06066c.5857-.585786.5857-1.535534 0-2.12132l-9.546-9.54594c-.5858-.5858-1.5355-.5858-2.1213 0-.5858.5858-.5858 1.53553 0 2.12132L32.8787 0l-8.4853 8.48528c-.5858.58579-.5858 1.53552 0 2.12132.5858.5858 1.5355.5858 2.1213 0l9.546-9.54594zM0 1.5h35v-3H0v3z" transform="rotate(180 18.5 6)" fill="#888" /></svg></a>
		<div class="s-x-26 m-y-5">
			<div>
				<h1 class="s-x-26 a-t-c">Moon: Pure UI</h1>
				<p class="s-x-26 a-t-c">January 12, 2020</p>
			</div>
			<div class="s-x-26 m-y-3">
				<p class="s-x-26"><a href="https://moonjs.org">Moon</a> is a web library that runs applications as pure functions.</p><p class="s-x-26">User interfaces (UIs) underpin almost all software. As with other programs, they transform and process data. However, they must also harmonize users with the underlying computer. People input an endless stream of data, and the application output affects them in real-time.</p><p class="s-x-26">This means that a UI must be responsive and easy to conceptualize. Users interact with the application expecting constant, instant feedback. They want to work with it to solve their problems. The interface is the barrier between the problem and the solution. Users shouldn&#39;t have to wrestle with it. Thus, they should be capable of forming a clear mental representation of the UI.</p><p class="s-x-26"><img src="/img/moon/Figure1FastEasyUI.png" alt="Fast and easy UI"></p><p class="s-x-26">Functional programming, responsiveness, and conceptualization are connected. Pure functions allow both developers and users to visualize input and output states. Being simple to grok means clear implementations, free of scattered imperative code. Clear implementations lead to smooth optimization, speed, and efficiency.</p><p class="s-x-26">Moon streamlines UI development with pure functions. I&#39;ve lost count of the number of times that I&#39;ve redesigned its API. Every single iteration felt incomplete. Little inconsistencies here and there would leave the perfectionist in me unsatisfied.</p><p class="s-x-26">Other libraries had conditioned me to lean towards similar designs. The mental model that came with React or Vue always found its way into Moon. So, over a week, I erased everything that I knew about user interfaces and tried to create something from scratch.</p><p class="s-x-26">That week grew philosophical as I questioned modern UI development.</p><ul>
<li><p class="s-x-26"><em>Why is view a function of state?</em></p></li><li><p class="s-x-26"><em>Why do we need components?</em></p></li><li><p class="s-x-26"><em>Why do components have local state?</em></p></li><li><p class="s-x-26"><em>If the view is a function of state, what about other effects?</em></p></li></ul>
<p class="s-x-26">Popular UI libraries treat views as functions of state, but UIs aren&#39;t states and views. They&#39;re everything: mapping inputs from the user to outputs on the computer.</p><p class="s-x-26">A UI can take information from the mouse, keyboard, webcam, or mic. After processing this data, it can output to the screen, speakers, network, or hard drive.</p><p class="s-x-26">With this definition, UI becomes a pure function.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code>application(sensory input) = output signals</code></pre><p class="s-x-26">Four years of reiterating on Moon with complex API rewrites led to this idea. In hindsight, it seems obvious; represent UI as a function. But it can be hard to see through the forest of abstractions in the UI development world. If anything, the simplicity reinforces that functions are a natural way of defining UIs.</p><p class="s-x-26">Pure functions replace contrived models. Moon allows applications to interact with the world using drivers. It revitalizes UI development with composition, straightforward testing, time-travel debugging, and faster performance.</p><h2 id="background" class="s-x-26">Background</h2><p class="s-x-26">UI development finds its roots in object-oriented, imperative code. As paradigms shift, two ideas have remained constant: state and views.</p><p class="s-x-26">State is a data structure. This structure can hold any value relevant to the application, including numbers, strings, lists, or objects. Applications initialize the state with data and store it in memory. As users interact with the UI, it transforms the state.</p><p class="s-x-26">Most UIs revolve around state. This means that if an application holds a certain state, it will always have the same UI. In these cases, the state is the sole source of truth and describes every aspect of the UI.</p><p class="s-x-26">Null values describe the absence of a value. Applications use them to handle states that can&#39;t exist yet. For example, a UI can use state to store a selected item in a list. If the user hasn&#39;t selected an item, developers may represent it with <code class="s-b-2 p-x-2 p-y-2">null</code>.</p><p class="s-x-26">Boolean values represent two states, true or false. Two states are so convenient that programming languages natively support them. They are effective at denoting loading states, activation states, or authentication status.</p><p class="s-x-26">Numbers represent quantitative data. They can describe values such as counts, ages, money, likes, or followers. In addition, they can track the index to a list. For example, a number state value can reference the index of a selected item in a list.</p><p class="s-x-26">Strings represent text. This includes names, usernames, descriptions, and other text content. Similar to numbers, they can serve as a key to an object. For example, a string state value can hold a selected username. This username can map to user information in an object.</p><p class="s-x-26">Lists represent sets of ordered data. This can be a list of todos, users, transactions, or recipes. They are often cons cells or arrays with integer indexes.</p><p class="s-x-26">Objects resemble lists with indexes, but accept any index type instead of integers. For example, numbers and strings can both map to a value in an object. These are useful for structuring state in general or mapping keys to values. As state compounds, an object is useful for structure.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token punctuation">{</span>
    user<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        email<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    users<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    selected<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    isLoaded<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre><p class="s-x-26">This is the most common way of holding structured state. The overarching state tree should have a well-defined shape, and it determines the character of the UI.</p><p class="s-x-26">The view displays data from the state. In graphical user interfaces, the view is a screen. Views can exhibit the state on devices such as smart watches, mobile phones, laptops, monitors, or television screens. Operating systems represent the display with a buffer holding colors for each pixel.</p><p class="s-x-26">TODO: define state, what it represents, how it is managed, and what it does for an application. define views, what they represent, how they are represented in pixels, how they are abstracted with GUI widgets and the DOM, and how the DOM is constructed and manipulated. define existing models: vanilla js with event loop and DOM manipulation, vue.js reactive updates, react component view as function of local component state, elm model-view-update. in each model, describe a basic example (counter) and mention how they each allow composition and building of reponsive UIs with easy conceptualization, including ideas such as components, events, state, and communication between components.</p><p class="s-x-26">TODO: define current state of managing state (especially difficulties). start with object oriented and imperative state updates and move into functional programming techniques for representing state, which is a fundamentally mutable value. have examples of state management code throughout.</p><p class="s-x-26">Manipulating the display buffer palls when managing complex elements. Developers would have to define every interaction&#39;s effect in terms of individual pixels. This means conducting text, images, inputs, and buttons at the same time.</p><p class="s-x-26">GUI frameworks circumvent this by defining reusable widgets. On the web, browsers abstract the view with the document object model (DOM).</p><p class="s-x-26">TODO: define GUI frameworks and DOM, saying how they use imperative code for construction and mutation. show the problems with composition and reuse due to mutation. have code samples for DOM construction and mutation. transition into MVC.</p><p class="s-x-26">TODO: define MVC, difficulties with MVC, and some examples with MVC. transition into using functional programming to solve some issues with state management and views by representing the view as a value, and defining it as a function of state.</p><p class="s-x-26">Developers are drifting away from object-oriented components and the Model-View-Controller (MVC) model. The current status quo of UI development defines views as a function of state.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code>application(state) = view</code></pre><p class="s-x-26">With this model, the state, a dynamic value, is immutable. Applications change the state by constructing a new one from scratch and replacing the old one.</p><p class="s-x-26">TODO: add more examples and justification for this functional idea then transition into current frameworks for functional UI in the imperative DOM (react, elm, cycle). introduce the mental models that comes with each of these frameworks</p><p class="s-x-26"><a href="https://reactjs.org">React</a> popularized this idea. It introduces components, each of which returns a view based on local state. The state is a JavaScript object, and the view is an object representing a virtual DOM. The virtual DOM is a tree describing the DOM.</p><p class="s-x-26">For example, a counter application in React stores a count in state and renders it to a view.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Access state with an magical "hook".</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return a view.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
            <span class="token punctuation">{</span>count<span class="token punctuation">}</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p class="s-x-26">The goal is to represent the view as a pure function of state, but React uses &quot;hooks&quot; instead. Rather than passing global state as a parameter, it links local state to components. Hooks like <code class="s-b-2 p-x-2 p-y-2">useState</code> access this state and store it based on a component&#39;s position in a tree.</p><p class="s-x-26">Local state replacing function parameters means that React apps are not pure. They rely on positions in the tree to store local state, requiring abstractions like keys, context, and state libraries to maintain.</p><p class="s-x-26">The React model also limits UI input to state and output to views. All other inputs and effects are second-class citizens.</p><p class="s-x-26">For example, displaying the time would break out of the functional mental model. It needs input from an impure function and depends on the developer to handle timing effects.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store time in state.</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> setTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Manually handle a timing interval effect.</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">interval</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">setTime</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token function">setInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return a view based on the time stored in the state.</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p class="s-x-26">Most applications need inputs other than state and effects other than views. Even the basic clock UI needs them. React allows writing custom events with the effect hook. But as with all other hooks, writing effects in the body of a function rather than as a return value introduces impurity.</p><p class="s-x-26">Since local state is the sole input, it must store the time. However, this is convoluted. Passing it as an input to the function is clearer.</p><h2 id="moon" class="s-x-26">Moon</h2><p class="s-x-26">TODO: introduce Moon&#39;s mental model of a UI as a function. introduce drivers and run function.</p><p class="s-x-26">Computers are imperative, based on operations that mutate the internal state. This includes registers, memory, and other hardware. Until computers treat software as a function, providing inputs and handling outputs, we&#39;ll use drivers.</p><p class="s-x-26">Drivers are an interface between software and hardware. They bridge the gap between functional applications and imperative devices.</p><p class="s-x-26">A driver captures data coming in from devices and sends data back to them. Consequently, in most modern languages, a driver is a module with two functions: one for input and one for output.</p><p class="s-x-26">In an ideal world, a computer would call an application function every cycle. To simulate this, the computer should run the application when inputs change. One can pipe input data from drivers to the application. Then, they can route return values to the appropriate driver output functions.</p><p class="s-x-26">Moon&#39;s <a href="https://github.com/kbrsh/moon/blob/master/packages/moon/src/run.js">run</a> function does this. The implementation (without error handling) is succinct.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">application</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get inputs from all drivers.</span>
    <span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> driver <span class="token keyword">in</span> drivers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        input<span class="token punctuation">[</span>driver<span class="token punctuation">]</span> <span class="token operator">=</span> drivers<span class="token punctuation">[</span>driver<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Get the application output.</span>
    <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token function">application</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Execute drivers with the outputs.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> driver <span class="token keyword">in</span> output<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        drivers<span class="token punctuation">[</span>driver<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>output<span class="token punctuation">[</span>driver<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p class="s-x-26">Each driver is an object with an input and output function. For example, a driver for manipulating RAM, i.e. storing data in a variable is trivial to implement.</p><pre class="s-x-26 s-b-2 p-x-4 p-y-4"><code><span class="token keyword">let</span> data<span class="token punctuation">;</span>

<span class="token keyword">const</span> driver <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">output</span><span class="token punctuation">(</span><span class="token parameter">dataNew</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> dataNew<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p class="s-x-26">In fact, this is how Moon&#39;s <a href="https://github.com/kbrsh/moon/blob/master/packages/moon/src/data/driver.js">data driver</a> works.</p><h2 id="data" class="s-x-26">Data</h2><p class="s-x-26">TODO: define data driver, discuss implementation, introduce single state tree, describe examples of managing single state trees with determinism, purity, reducers, etc.</p><h2 id="views" class="s-x-26">Views</h2><p class="s-x-26">TODO: define view driver, discuss implementation details (virtual DOM, node reference check), Moon View Language, components</p><h2 id="time" class="s-x-26">Time</h2><p class="s-x-26">TODO: define time driver, discuss implementation</p><h2 id="storage" class="s-x-26">Storage</h2><p class="s-x-26">TODO: define storage driver, discuss implementation</p><h2 id="http" class="s-x-26">HTTP</h2><p class="s-x-26">TODO: define HTTP driver, discuss implementation</p><h2 id="route" class="s-x-26">Route</h2><p class="s-x-26">TODO: define route driver, discuss implementation</p><h2 id="composition" class="s-x-26">Composition</h2><p class="s-x-26">TODO: define composition of functions that each take driver inputs and return driver outputs (similar to cycle)</p><h2 id="concurrency" class="s-x-26">Concurrency</h2><p class="s-x-26">TODO: define concurrency, say how it can be used in general when running the application function just like any other functional language and when outputting to multiple drivers at once. inputs can&#39;t be concurrent because they are sampled directly from devices, and these devices must be responsible for tracking concurrent inputs (such as a keyboard, where the browser or keyboard automatically orders events)</p><h2 id="testing" class="s-x-26">Testing</h2><p class="s-x-26">TODO: define testing, introduce testing techniques using input/output assertions, discuss how even randomness, time, or even network requests can be made deterministic because of the nature of drivers</p><h2 id="debugging" class="s-x-26">Debugging</h2><p class="s-x-26">TODO: define debugging, introduce advantages of debugging with pure functions that use immutable state for all drivers (time travel debugging)</p><h2 id="optimization" class="s-x-26">Optimization</h2><p class="s-x-26">TODO: define optimization techniques of functional programming, including tail recursion, memoization, caching, loop unrolling, etc.</p><h2 id="examples" class="s-x-26">Examples</h2><p class="s-x-26">TODO: counter, clock, todo app, chat app, audio (radio?)/video app</p><h2 id="conclusion" class="s-x-26">Conclusion</h2><p class="s-x-26">TODO: summarize old techniques and Moon&#39;s new model</p>
			</div>
			<div class="s-x-26 a-x-sb">
				<p><a href="https://kabir.sh">Portfolio</a></p>
				<p><a href="https://blog.kabir.sh">Blog</a></p>
				<p><a href="https://twitter.com/kbrshah">Twitter</a></p>
				<p><a href="https://github.com/kbrsh">GitHub</a></p>
			</div>
		</div>
	</body>
</html>
